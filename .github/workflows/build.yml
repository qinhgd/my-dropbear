name: Build Static Dropbear for ARMv7

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          # 安装交叉编译器以及目标架构的开发库
          sudo apt-get install -y gcc-arm-linux-gnueabihf binutils-arm-linux-gnueabihf \
                                 libc6-dev-armhf-cross make wget upx-ucl bzip2

      - name: Download Dropbear Source
        run: |
          DROPBEAR_VERSION="2024.84"
          wget https://matt.ucc.asn.au/dropbear/releases/dropbear-${DROPBEAR_VERSION}.tar.bz2
          tar -xjf dropbear-${DROPBEAR_VERSION}.tar.bz2
          mv dropbear-${DROPBEAR_VERSION} dropbear-src

      - name: Configure and Build
        run: |
          cd dropbear-src
          
          # 强制开启密码登录
          cat > localoptions.h <<EOF
          #define DROPBEAR_SVR_PASSWORD_AUTH 1
          #define DROPBEAR_SVR_PUBKEY_AUTH 1
          #define HAVE_CRYPT 1
          EOF

          # 关键修复：先不带 -static 进行 configure，在 make 时强制静态链接
          # 这样可以避免 configure 脚本在检测编译器时因为找不到静态库而崩溃
          ./configure \
            --host=arm-linux-gnueabihf \
            --disable-zlib \
            --disable-lastlog \
            --disable-utmp \
            --disable-utmpx \
            --disable-wtmp \
            --disable-wtmpx \
            --disable-loginfunc \
            --disable-pututline \
            --disable-pututxline \
            CC=arm-linux-gnueabihf-gcc

          # 在 make 阶段通过 STATIC=1 或手动指定 LDFLAGS 实现静态编译
          # 同时链接 crypt 库
          make PROGRAMS="dropbear dbclient dropbearkey" \
               LDFLAGS="-static" \
               LIBS="-lcrypt" \
               -j$(nproc)

      - name: Compress with UPX
        run: |
          cd dropbear-src
          upx --best dropbear dbclient dropbearkey || true

      - name: Prepare Artifacts
        run: |
          mkdir -p output
          cp dropbear-src/dropbear output/
          cp dropbear-src/dbclient output/
          cp dropbear-src/dropbearkey output/
          mv output dropbear_armv7_static

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dropbear-armv7-static-binaries
          path: dropbear_armv7_static/
