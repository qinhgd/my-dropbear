name: Build Static Dropbear for ARMv7 (Password Auth Enabled)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          # 安装交叉编译器和必要的静态库
          sudo apt-get install -y gcc-arm-linux-gnueabihf make wget upx-ucl bzip2

      - name: Download Dropbear Source
        run: |
          DROPBEAR_VERSION="2024.84"
          wget https://matt.ucc.asn.au/dropbear/releases/dropbear-${DROPBEAR_VERSION}.tar.bz2
          tar -xjf dropbear-${DROPBEAR_VERSION}.tar.bz2
          mv dropbear-${DROPBEAR_VERSION} dropbear-src

      - name: Configure and Build
        run: |
          cd dropbear-src
          
          # 1. 强制启用密码登录配置
          # 2. 预设 HAVE_CRYPT 避免 configure 阶段的误判
          cat > localoptions.h <<EOF
          #define DROPBEAR_SVR_PASSWORD_AUTH 1
          #define DROPBEAR_SVR_PUBKEY_AUTH 1
          #define HAVE_CRYPT 1
          EOF

          # 强制设置环境参数
          export CC=arm-linux-gnueabihf-gcc
          export AR=arm-linux-gnueabihf-ar
          export RANLIB=arm-linux-gnueabihf-ranlib

          ./configure \
            --host=arm-linux-gnueabihf \
            --disable-zlib \
            --disable-lastlog \
            --disable-utmp \
            --disable-utmpx \
            --disable-wtmp \
            --disable-wtmpx \
            --disable-loginfunc \
            --disable-pututline \
            --disable-pututxline \
            LDFLAGS="-static" \
            LIBS="-lcrypt"

          # 编译
          make PROGRAMS="dropbear dbclient dropbearkey" -j$(nproc)

      - name: Compress with UPX
        run: |
          cd dropbear-src
          # 忽略压缩失败的错误（有些静态包过小可能无法压缩）
          upx --best dropbear dbclient dropbearkey || true

      - name: Prepare Artifacts
        run: |
          mkdir -p output
          cp dropbear-src/dropbear output/
          cp dropbear-src/dbclient output/
          cp dropbear-src/dropbearkey output/
          mv output dropbear_armv7_static

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dropbear-armv7-static-binaries
          path: dropbear_armv7_static/
