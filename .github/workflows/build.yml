name: Build Static Dropbear for ARMv7

on:
  workflow_dispatch: # 支持手动触发编译

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-linux-gnueabihf make wget upx-ucl bzip2

      - name: Download Dropbear Source
        run: |
          # 你可以更改版本号，2024.84 是较新版本
          DROPBEAR_VERSION="2024.84"
          wget https://matt.ucc.asn.au/dropbear/releases/dropbear-${DROPBEAR_VERSION}.tar.bz2
          tar -xjf dropbear-${DROPBEAR_VERSION}.tar.bz2
          mv dropbear-${DROPBEAR_VERSION} dropbear-src

      - name: Configure and Build
        run: |
          cd dropbear-src
          
          # 关键点：LDFLAGS="-static" 确保生成的二进制不依赖系统库
          # --disable-zlib 进一步减小体积（如果光猫上没有 zlib）
          ./configure \
            --host=arm-linux-gnueabihf \
            --disable-zlib \
            --disable-lastlog \
            --disable-utmp \
            --disable-utmpx \
            --disable-wtmp \
            --disable-wtmpx \
            --disable-loginfunc \
            --disable-pututline \
            --disable-pututxline \
            CC=arm-linux-gnueabihf-gcc \
            LDFLAGS="-static"

          # 只编译核心程序：服务端、客户端、密钥生成工具
          make PROGRAMS="dropbear dbclient dropbearkey" -j$(nproc)

      - name: Compress with UPX
        run: |
          cd dropbear-src
          # 压缩二进制文件，节省光猫内存空间
          upx --best dropbear dbclient dropbearkey

      - name: Prepare Artifacts
        run: |
          mkdir -p output
          cp dropbear-src/dropbear output/
          cp dropbear-src/dbclient output/
          cp dropbear-src/dropbearkey output/
          # 根据你的习惯，重命名文件夹以符合规范
          mv output dropbear_armv7_static

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dropbear-armv7-static-binaries
          path: dropbear_armv7_static/
