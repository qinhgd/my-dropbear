name: Build Perfect Static Dropbear for ARMv7 (musl)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install musl toolchain
        run: |
          sudo apt-get update
          # 下载专门的 arm-musl 交叉编译器
          wget https://musl.cc/arm-linux-musleabihf-cross.tgz
          tar -xzf arm-linux-musleabihf-cross.tgz
          echo "$(pwd)/arm-linux-musleabihf-cross/bin" >> $GITHUB_PATH

      - name: Download Dropbear Source
        run: |
          DROPBEAR_VERSION="2024.84"
          wget https://matt.ucc.asn.au/dropbear/releases/dropbear-${DROPBEAR_VERSION}.tar.bz2
          tar -xjf dropbear-${DROPBEAR_VERSION}.tar.bz2
          mv dropbear-${DROPBEAR_VERSION} dropbear-src

      - name: Configure and Build
        run: |
          cd dropbear-src
          
          # 强制开启密码登录
          cat > localoptions.h <<EOF
          #define DROPBEAR_SVR_PASSWORD_AUTH 1
          #define DROPBEAR_SVR_PUBKEY_AUTH 1
          #define HAVE_CRYPT 1
          EOF

          # 使用 musl-gcc 进行配置
          # musl 环境下不需要单独链接 libcrypt，因为它已经包含在 libc 中
          ./configure \
            --host=arm-linux-musleabihf \
            --disable-zlib \
            --disable-lastlog \
            --disable-utmp \
            --disable-utmpx \
            --disable-wtmp \
            --disable-wtmpx \
            --disable-loginfunc \
            --disable-pututline \
            --disable-pututxline \
            CC=arm-linux-musleabihf-gcc

          # 执行静态编译
          make PROGRAMS="dropbear dbclient dropbearkey" \
               LDFLAGS="-static" \
               -j$(nproc)

      - name: Compress with UPX
        run: |
          cd dropbear-src
          sudo apt-get install -y upx-ucl
          upx --best dropbear dbclient dropbearkey || true

      - name: Prepare Artifacts
        run: |
          mkdir -p output
          cp dropbear-src/dropbear output/
          cp dropbear-src/dbclient output/
          cp dropbear-src/dropbearkey output/
          mv output dropbear_armv7_musl_static

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dropbear-armv7-musl-static
          path: dropbear_armv7_musl_static/
